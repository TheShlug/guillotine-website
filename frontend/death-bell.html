<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="The Death Bell tolls for players who brought doom to their owners in The Guillotine Fantasy Football League.">
  <meta name="theme-color" content="#dc2626">
  <title>Death Bell - The Guillotine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#x1FA93;</text></svg>">
  <style>
    .death-bell-page {
      max-width: 1000px;
      margin: 0 auto;
    }

    .page-hero {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .page-hero h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: var(--spacing-sm);
    }

    .page-hero .skull {
      font-size: 3rem;
      display: block;
      margin-bottom: var(--spacing-md);
    }

    .page-hero p {
      color: var(--color-text-secondary);
      font-size: 1.1rem;
    }

    .season-selector {
      display: flex;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-xl);
    }

    .season-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      background: transparent;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .season-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent-light);
    }

    .season-btn.active {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: white;
    }

    .explanation-box {
      background: linear-gradient(135deg, var(--color-bg-card) 0%, rgba(220, 38, 38, 0.1) 100%);
      border: 1px solid var(--color-accent-dark);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .explanation-box p {
      color: var(--color-text-secondary);
      line-height: 1.8;
      margin: 0;
    }

    .multi-chop-section {
      margin-bottom: var(--spacing-xl);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .player-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-md);
      overflow: hidden;
    }

    .player-card.highlight {
      border-color: var(--color-accent);
      box-shadow: 0 0 20px rgba(220, 38, 38, 0.2);
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--color-bg-elevated);
    }

    .player-name {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .chop-count {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .chop-badge {
      background: linear-gradient(135deg, #7f1d1d, #dc2626);
      color: white;
      font-size: 0.85rem;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 700;
    }

    .chop-badge.multi {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
    }

    .chop-timeline {
      padding: var(--spacing-md) var(--spacing-lg);
    }

    .chop-event {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--color-border);
    }

    .chop-event:last-child {
      border-bottom: none;
    }

    .chop-week {
      background: var(--color-chop-week);
      color: white;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }

    .chop-manager {
      color: var(--color-text-secondary);
    }

    .chop-manager strong {
      color: var(--color-text);
    }

    .starter-badge {
      background: var(--color-accent-light);
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: auto;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .stat-box {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      text-align: center;
    }

    .stat-box .value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--color-accent-light);
    }

    .stat-box .label {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--color-text-secondary);
      text-decoration: none;
      font-weight: 500;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
      margin-bottom: var(--spacing-lg);
    }

    .back-link:hover {
      color: var(--color-accent-light);
      background: var(--color-bg-card);
    }

    .loading-state, .error-state {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--color-text-secondary);
    }

    .no-multi-chop {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--color-text-muted);
      font-style: italic;
    }

    @media (max-width: 768px) {
      .page-hero h1 {
        font-size: 1.75rem;
      }

      .chop-event {
        flex-wrap: wrap;
      }

      .starter-badge {
        margin-left: 0;
        margin-top: var(--spacing-xs);
      }
    }
  </style>
</head>
<body>
  <div class="app-container death-bell-page">
    <a href="/" class="back-link">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Standings
    </a>

    <div class="page-hero">
      <span class="skull">&#x1F480;</span>
      <h1>The Death Bell</h1>
      <p>Players who brought doom to their owners</p>
    </div>

    <div class="explanation-box">
      <p>
        <strong>The Death Bell tolls</strong> for players who were rostered on teams that got chopped.
        Some players are picked up multiple times only to see their new team eliminated.
        These cursed players carry the mark of the guillotine with them.
      </p>
    </div>

    <div class="season-selector" id="season-selector">
      <!-- Populated by JS -->
    </div>

    <div id="stats-summary">
      <!-- Stats populated by JS -->
    </div>

    <div id="content-container">
      <div class="loading-state">
        <div class="axe-spinner" style="font-size: 2rem; margin-bottom: 1rem;">&#x1FA93;</div>
        <p>Loading death bell data...</p>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-links">
        <a href="/" class="footer-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          Home
        </a>
        <a href="/rules" class="footer-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          League Rules
        </a>
        <a href="/average-finishes" class="footer-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20V10"/>
            <path d="M18 20V4"/>
            <path d="M6 20v-4"/>
          </svg>
          Historical Stats
        </a>
        <a href="/draft-order" class="footer-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 3h5v5"/>
            <path d="M8 3H3v5"/>
            <path d="M21 3l-7 7"/>
            <path d="M3 3l7 7"/>
          </svg>
          Draft Order
        </a>
        <a href="/transactions" class="footer-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          Transactions
        </a>
        <a href="/average-finishes" class="footer-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Manager Profiles
        </a>
      </div>
      <p class="footer-note">
        Data powered by <a href="https://sleeper.app" target="_blank" rel="noopener">Sleeper</a>
      </p>
    </footer>
  </div>

  <script type="module">
    import { fetchAvailableSeasons } from '/js/api.js';

    let currentSeason = null;

    async function loadSeasons() {
      const seasonsInfo = await fetchAvailableSeasons();
      const selector = document.getElementById('season-selector');

      // Show all seasons (both API and historical)
      const allSeasons = seasonsInfo.seasons || [];

      if (allSeasons.length === 0) {
        selector.innerHTML = '<p>No seasons available</p>';
        return;
      }

      allSeasons.forEach(season => {
        const btn = document.createElement('button');
        btn.className = 'season-btn';
        btn.textContent = season;
        btn.onclick = () => loadDeathBell(season);
        selector.appendChild(btn);
      });

      // Load most recent season
      currentSeason = Math.max(...allSeasons);
      loadDeathBell(currentSeason);
    }

    async function loadDeathBell(season) {
      currentSeason = season;

      // Update button states
      document.querySelectorAll('.season-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent == season);
      });

      const container = document.getElementById('content-container');
      const statsContainer = document.getElementById('stats-summary');

      container.innerHTML = `
        <div class="loading-state">
          <div class="axe-spinner" style="font-size: 2rem; margin-bottom: 1rem;">&#x1FA93;</div>
          <p>Loading death bell data...</p>
        </div>
      `;

      try {
        const response = await fetch(`/api/seasons/${season}/chopped-players`);
        if (!response.ok) throw new Error('Failed to load data');
        const data = await response.json();

        // Check if data is available for this season
        if (data.message || data.chopped_players.length === 0) {
          statsContainer.innerHTML = '';
          container.innerHTML = `
            <div class="no-multi-chop" style="padding: var(--spacing-2xl);">
              <p style="font-size: 1.1rem; margin-bottom: var(--spacing-md);">&#x1F6AB; Roster Data Not Available</p>
              <p style="color: var(--color-text-muted);">
                The Death Bell requires detailed roster data from Sleeper which is not available for this historical season.
                This feature is only available for live seasons where we can track player movements.
              </p>
            </div>
          `;
          return;
        }

        // Calculate stats
        const multiChopPlayers = data.chopped_players.filter(p => p.times_chopped >= 2);
        const maxChops = Math.max(...data.chopped_players.map(p => p.times_chopped), 0);

        // Render stats
        statsContainer.innerHTML = `
          <div class="stats-summary">
            <div class="stat-box">
              <div class="value">${data.total_unique_players_chopped}</div>
              <div class="label">Players Chopped</div>
            </div>
            <div class="stat-box">
              <div class="value">${multiChopPlayers.length}</div>
              <div class="label">Multi-Chop Players</div>
            </div>
            <div class="stat-box">
              <div class="value">${maxChops}</div>
              <div class="label">Most Chops (Single Player)</div>
            </div>
            <div class="stat-box">
              <div class="value">${data.current_week}</div>
              <div class="label">Current Week</div>
            </div>
          </div>
        `;

        // Build HTML
        let html = '';

        // Multi-chop players section
        if (multiChopPlayers.length > 0) {
          html += `
            <div class="multi-chop-section">
              <h2 class="section-title">&#x2620; Repeat Offenders</h2>
              <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
                These players have been chopped with multiple teams this season.
              </p>
          `;

          multiChopPlayers.forEach(player => {
            const isHighlight = player.times_chopped >= 3;
            html += `
              <div class="player-card ${isHighlight ? 'highlight' : ''}">
                <div class="player-header">
                  <span class="player-name">${player.player_name}</span>
                  <div class="chop-count">
                    <span class="chop-badge ${player.times_chopped >= 3 ? 'multi' : ''}">${player.times_chopped}x Chopped</span>
                  </div>
                </div>
                <div class="chop-timeline">
                  ${player.chop_events.map(event => `
                    <div class="chop-event">
                      <span class="chop-week">Week ${event.week}</span>
                      <span class="chop-manager">with <strong>${event.manager}</strong></span>
                      ${event.was_starter ? '<span class="starter-badge">STARTER</span>' : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          });

          html += '</div>';
        } else {
          html += `<div class="no-multi-chop">No players have been chopped multiple times yet this season.</div>`;
        }

        // Single chop players (collapsed)
        const singleChopPlayers = data.chopped_players.filter(p => p.times_chopped === 1);
        if (singleChopPlayers.length > 0) {
          html += `
            <div class="multi-chop-section">
              <h2 class="section-title">&#x1FA93; All Chopped Players (${singleChopPlayers.length})</h2>
              <details style="margin-top: var(--spacing-md);">
                <summary style="cursor: pointer; color: var(--color-text-secondary); padding: var(--spacing-sm);">
                  Click to expand full list
                </summary>
                <div style="margin-top: var(--spacing-md);">
          `;

          // Group by week
          const byWeek = {};
          singleChopPlayers.forEach(player => {
            const week = player.chop_events[0].week;
            if (!byWeek[week]) byWeek[week] = [];
            byWeek[week].push(player);
          });

          Object.keys(byWeek).sort((a, b) => a - b).forEach(week => {
            html += `
              <div style="margin-bottom: var(--spacing-md);">
                <h4 style="color: var(--color-text-muted); margin-bottom: var(--spacing-sm);">Week ${week} - ${byWeek[week][0].chop_events[0].manager}</h4>
                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                  ${byWeek[week].map(p => `
                    <span style="background: var(--color-bg-elevated); padding: 4px 10px; border-radius: 6px; font-size: 0.85rem;">
                      ${p.player_name}
                    </span>
                  `).join('')}
                </div>
              </div>
            `;
          });

          html += '</div></details></div>';
        }

        container.innerHTML = html;

      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = `<div class="error-state">Failed to load death bell data</div>`;
      }
    }

    loadSeasons();
  </script>
</body>
</html>
